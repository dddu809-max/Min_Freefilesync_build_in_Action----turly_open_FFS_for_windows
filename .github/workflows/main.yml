name: Build MinFFS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    steps:
      # 1. 拉代码
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. 安装 MinGW 和 7zip（用 choco）
      - name: Install MinGW and 7zip
        run: |
          choco install -y mingw
          choco install -y 7zip

      # 3. 构建 wxWidgets 3.0.2，根目录用 C:\wx-src
      - name: Build wxWidgets 3.0.2 (MinGW)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "=== wx STEP 1: download wxWidgets zip ==="
          curl -L "https://sourceforge.net/projects/wxwindows/files/3.0.2/wxWidgets-3.0.2.zip/download" -o wxWidgets-3.0.2.zip

          # 解压到 C:\wx-src （根据 probe 的结果，这就是解压后的根目录）
          $wxRoot = "C:\wx-src"
          if (Test-Path $wxRoot) {
            Remove-Item $wxRoot -Recurse -Force
          }
          New-Item -ItemType Directory -Path $wxRoot | Out-Null

          Write-Host "=== wx STEP 2: expand archive to $wxRoot ==="
          Expand-Archive -Path "wxWidgets-3.0.2.zip" -DestinationPath $wxRoot -Force

          Write-Host "=== wx STEP 3: list top-level of $wxRoot for sanity ==="
          Get-ChildItem $wxRoot

          # 配环境：WXWIN + PATH
          $env:WXWIN = $wxRoot
          $env:PATH  = "C:\ProgramData\mingw64\mingw64\bin;$env:PATH"

          Write-Host "=== wx STEP 4: go to MSW build dir and build ==="
          Set-Location "$wxRoot\build\msw"

          Write-Host "PWD = $(Get-Location)"

          # 关键点：明确告诉 make 用 cmd.exe 当 SHELL，避免之前那个路径当壳的问题
          mingw32-make -f makefile.gcc BUILD=release SHARED=0 CXXFLAGS="-std=gnu++14" SHELL=cmd.exe
          mingw32-make -f makefile.gcc BUILD=debug   SHARED=0 CXXFLAGS="-std=gnu++14" SHELL=cmd.exe

      # 4. 构建 Boost 1.58.0，安装到 C:\Boost-w64
      - name: Build Boost 1.58.0 (MinGW)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $boostRoot = "C:\build-boost"
          if (-Not (Test-Path $boostRoot)) {
            New-Item -ItemType Directory -Path $boostRoot | Out-Null
          }

          Set-Location $boostRoot

          Write-Host "=== BOOST STEP 1: download boost_1_58_0.zip ==="
          curl -L "https://sourceforge.net/projects/boost/files/boost/1.58.0/boost_1_58_0.zip/download" -o boost_1_58_0.zip

          Write-Host "=== BOOST STEP 2: expand archive ==="
          if (Test-Path "$boostRoot\boost_1_58_0") {
            Remove-Item "$boostRoot\boost_1_58_0" -Recurse -Force
          }
          Expand-Archive -Path "boost_1_58_0.zip" -DestinationPath $boostRoot -Force

          Set-Location "$boostRoot\boost_1_58_0"

          # 确保 MinGW 在 PATH 里
          $env:PATH = "C:\ProgramData\mingw64\mingw64\bin;$env:PATH"

          Write-Host "=== BOOST STEP 3: bootstrap + b2 install ==="
          .\bootstrap.bat mingw

          .\b2 toolset=gcc `
             variant=release `
             threading=multi `
             --prefix=C:\Boost-w64 `
             --without-mpi `
             --without-python install

      # 5. 用 MinGW 平台的 Makefile 编译 MinFFS
      - name: Build MinFFS (MinGW)
        working-directory: src+builder/FreeFileSync/Platforms/MinGW
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # 保证 MinGW 在 PATH 里
          $env:PATH = "C:\ProgramData\mingw64\mingw64\bin;$env:PATH"

          Write-Host "=== MinFFS STEP: build with MinGW ==="
          mingw32-make -f Makefile-cmdexe.mk `
            MINGW_ROOT=C:/ProgramData/mingw64/mingw64 `
            WXWGT_ROOT=C:/wx-src `
            BOOST_ROOT=C:/Boost-w64 `
            BOOST_VER=1_58 `
            BOOST_MINGW=mgw52 `
            all

      # 6. 上传生成的 MinFFS.exe
      - name: Upload MinFFS.exe
        uses: actions/upload-artifact@v4
        with:
          name: MinFFS
          path: src+builder/FreeFileSync/Platforms/MinGW/MinFFS.exe
          if-no-files-found: error
